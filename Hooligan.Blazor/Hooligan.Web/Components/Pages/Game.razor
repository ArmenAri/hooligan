@page "/Game"
@using Hooligan.Web.Models
@rendermode InteractiveServer

@inject HooliganApiClient HooliganApi
@inject ISnackbar Snackbar

<PageTitle>Game</PageTitle>

<h1>Hooligan Infinite Craft Game</h1>

<MudDropContainer
    T="Item"
    Items="_items"
    ItemsSelector="@((item, dropzone) => item.Identifier == dropzone)"
    ItemDropped="ItemUpdated"
    Class="d-flex flex-wrap flex-grow-1">
    <ChildContent>
        <MudDropZone T="Item" Identifier="@Identifiers.Discoveries.ToString()" Class="rounded mud-background-gray pa-6 ma-8 flex-grow-1">
            <MudText Typo="Typo.h6" Class="mb-4">@Identifiers.Discoveries.ToString()</MudText>
        </MudDropZone>
    </ChildContent>
    <ItemRenderer>
        <MudPaper
            @key="@context.Name"
            id="@context.Name"
            @ondrop="@(() => HandleDrop(@context))"
            Elevation="25"
            Class="pa-4 my-4">
            @context.Icon @context.Name.ToUpperInvariant()
        </MudPaper>
    </ItemRenderer>
</MudDropContainer>
<MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="@(() => Snackbar.Add("Simple Snackbar"))">
    Open Snackbar
</MudButton>

@code {

    protected override void OnInitialized()
    {
        base.OnInitialized();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopRight;
    }

    private Item? TargetItem { get; set; }

    private void HandleDrop(Item item)
    {
        TargetItem = item;
    }

    private async Task ItemUpdated(MudItemDropInfo<Item> dropItem)
    {
        ArgumentNullException.ThrowIfNull(dropItem.Item);

        if (TargetItem is not null)
        {
            var response = await HooliganApi.CreateAssociation(new CreateAssociationCommand
            (
                dropItem.Item.Name,
                TargetItem.Name
            ));

            if (response.IsFail())
            {
                Snackbar.Add(response.Error?.Message, Severity.Error, options => { options.ErrorIcon = Icons.Material.Filled.Error; });
            }
            else
            {
                _items.Add(new Item
                {
#pragma warning disable CS8601 // Possible null reference assignment.
                    Name = response.Value?.Result,
                    Icon = response.Value?.Icon
#pragma warning restore CS8601 // Possible null reference assignment.
                });
            }
        }

        TargetItem = null;
    }

    private readonly List<Item> _items =
    [
        new Item { Name = "earth", Icon = "🌍" },
        new Item { Name = "wind", Icon = "🌬️" },
        new Item { Name = "fire", Icon = "🔥" },
        new Item { Name = "water", Icon = "💧" }
    ];

}