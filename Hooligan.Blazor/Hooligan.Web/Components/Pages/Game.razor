@page "/Game"
@using Hooligan.Web.Models
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject IJSRuntime JSRuntime
@inject HooliganApiClient HooliganApi
@inject ILocalStorageService LocalStorage

<PageTitle>Game</PageTitle>

<h1>Hooligan Infinite Craft Game</h1>

<MudDropContainer
    T="DraggableItem"
    Items="Items"
    ItemsSelector="@((item, dropzone) => item.Identifier == dropzone)"
    ItemDropped="ItemUpdated"
    Class="d-flex flex-wrap flex-grow-1">
    <ChildContent>
        <MudDropZone T="DraggableItem" Identifier="@Identifiers.Discoveries.ToString()" Class="rounded mud-background-gray pa-6 ma-8 flex-grow-1">
            <MudText Typo="Typo.h6" Class="mb-4">@Identifiers.Discoveries.ToString()</MudText>
        </MudDropZone>
    </ChildContent>
    <ItemRenderer>
        <MudPaper 
            id="@context.Id"
            @key="@context.Name"
            @ondrop="@(() => HandleDrop(@context))"
            Elevation="25"
            Class="pa-4 my-4">
            @context.Icon @context.Name.ToUpperInvariant()
            <MudIconButton Icon="@Icons.Material.Filled.Delete" aria-label="delete" Size="Size.Small" @onclick="@(() => DeleteCurrentItem(context.Id))" />
        </MudPaper>
    </ItemRenderer>
</MudDropContainer>


@code {
    private List<DraggableItem> Items = new List<DraggableItem>();

    private List<DraggableItem> OriginalItems = new List<DraggableItem>
    {
        new DraggableItem { Id = Guid.NewGuid(), Name = "earth", Icon = "🌍" },
        new DraggableItem { Id = Guid.NewGuid(), Name = "wind", Icon = "🌬️" },
        new DraggableItem { Id = Guid.NewGuid(), Name = "fire", Icon = "🔥" },
        new DraggableItem { Id = Guid.NewGuid(), Name = "water", Icon = "💧" }
    };

    private DraggableItem? TargetItem { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Items.AddRange(OriginalItems);
        Items.AddRange(await GetDraggableItemsFromLocalStorage());
    }

    private void HandleDrop(DraggableItem item)
    {
        TargetItem = item;
    }

    private async Task ItemUpdated(MudItemDropInfo<DraggableItem> dropItem)
    {
        ArgumentNullException.ThrowIfNull(dropItem.Item);

        if (TargetItem is not null)
        {
            var created = await HooliganApi.CreateAssociation(dropItem.Item.Name, TargetItem.Name);
            ArgumentNullException.ThrowIfNull(created);

            var newDraggableItem = new DraggableItem
            {
                Id = Guid.NewGuid(),
                Name = created.Result,
                Icon = created.Icon
            };

            Items.Add(newDraggableItem);

            var localStorageDraggableItems = await GetDraggableItemsFromLocalStorage();
            localStorageDraggableItems.Add(newDraggableItem);

            await LocalStorage.SetItemAsync<List<DraggableItem>>("Hooligan.User.Session", localStorageDraggableItems);
        }

        TargetItem = null;
    }

    private async Task DeleteCurrentItem(Guid itemId)
    {
        Items.Remove(Items.Where(item => item.Id == itemId).First());
        var localStorageDraggableItems = await GetDraggableItemsFromLocalStorage();
        localStorageDraggableItems.Remove(localStorageDraggableItems.Where(item => item.Id == itemId).First());
        await LocalStorage.SetItemAsync<List<DraggableItem>>("Hooligan.User.Session", localStorageDraggableItems);
    }

    private async Task<List<DraggableItem>> GetDraggableItemsFromLocalStorage()
    {
        var localStorageItems = await LocalStorage.GetItemAsync<List<DraggableItem>>("Hooligan.User.Session");
        if (localStorageItems is not null && localStorageItems.Any())
        {
            return localStorageItems.ToList();
        }
        return new List<DraggableItem>();
    }
}